# Famlyr - Family Tree Application Plan

## Tech Stack (Confirmed)
| Layer | Technology |
|-------|------------|
| Orchestration | .NET Aspire |
| Backend | .NET 10, ASP.NET Core Web API |
| Frontend | SvelteKit + TypeScript |
| Database | PostgreSQL (via Aspire) + Entity Framework Core |
| Auth | ASP.NET Core Identity + JWT |
| Architecture | Clean Architecture (3 projects) |
| IDs | UUIDv7 (time-sortable, .NET 9+ native support) |

## Performance Requirements
- Support up to **1000 persons** per family tree
- Optimized viewing and editing for large trees

---

## Project Structure

```
famlyr/
├── src/
│   ├── Famlyr.AppHost/          # Aspire orchestrator (entry point)
│   ├── Famlyr.ServiceDefaults/  # Shared Aspire config (telemetry, health checks)
│   ├── Famlyr.Api/              # ASP.NET Core Web API (controllers, models)
│   ├── Famlyr.Core/             # Domain entities, interfaces, enums
│   ├── Famlyr.Infrastructure/   # EF Core DbContext, repositories
│   └── Famlyr.Web/              # SvelteKit frontend
├── tests/
│   ├── Famlyr.Api.Tests/
│   └── Famlyr.Core.Tests/
├── Famlyr.sln
└── README.md
```

---

## Implementation Steps

### Step 1: Aspire Solution Setup ✅ DONE
- [x] Aspire solution with AppHost, ServiceDefaults, Api projects
- [x] Core and Infrastructure class libraries created
- [x] Project references configured

### Step 2: Configure AppHost ✅ DONE
- [x] PostgreSQL configured via Aspire
- [x] API project wired up

### Step 3: Domain Entities ✅ DONE (#3)
- [x] `FamilyTree.cs` - tree metadata (Id, Name, Description, OwnerId, CreatedAt, UpdatedAt)
- [x] `Person.cs` - nullable FirstName/LastName for historical figures
- [x] `Relationship.cs` - connections between persons (SubjectId, RelativeId)
- [x] `Gender.cs` enum (Male, Female, Other, Unknown)
- [x] `RelationshipType.cs` enum (Parent, Spouse)
- [x] All entities use UUIDv7 (`Guid.CreateVersion7()`)

### Step 3.5: API Models & Sample Endpoint ✅ DONE
- [x] `FamilyTreeModel`, `PersonModel`, `RelationshipModel` in Api/Models/
- [x] `GET /api/FamilyTree/{id}` endpoint with sample data (12 persons, 4 generations)

### Step 4: Database Setup (#4) - TODO
- [ ] Add Aspire.Npgsql.EntityFrameworkCore.PostgreSQL package
- [ ] Create `FamlyrDbContext.cs`
- [ ] Configure entity relationships (fluent API)
- [ ] Register DbContext using Aspire extension
- [ ] Create initial migration

### Step 5: Authentication Setup - DEFERRED to v0.3
> Note: v0.1 endpoints are public (no authentication)

### Step 6: Core API Endpoints - IN PROGRESS
- [ ] `POST /api/trees` - Create tree (#6)
- [ ] `GET /api/trees/{id}` - Get tree with persons
- [ ] `PUT /api/trees/{id}` - Update tree
- [ ] `DELETE /api/trees/{id}` - Delete tree
- [ ] Person CRUD endpoints
- [ ] Relationship CRUD endpoints

### Step 7: Frontend Setup - TODO
- [ ] Initialize SvelteKit project
- [ ] Add Tailwind CSS
- [ ] Create API client

### Step 8: Tree Visualization - TODO
- [ ] d3.js for interactive rendering
- [ ] Viewport culling for large trees

---

## Data Model

### FamilyTree
| Column | Type | Notes |
|--------|------|-------|
| Id | UUIDv7 | PK, `Guid.CreateVersion7()` |
| Name | string | Required |
| Description | string? | Optional |
| OwnerId | Guid | FK → AspNetUsers (v0.3) |
| CreatedAt | DateTime | |
| UpdatedAt | DateTime | |

### Person
| Column | Type | Notes |
|--------|------|-------|
| Id | UUIDv7 | PK |
| FamilyTreeId | UUIDv7 | FK, indexed |
| FirstName | string? | **Optional** (unknown for historical figures) |
| LastName | string? | **Optional** (unknown for historical figures) |
| Gender | enum | Male, Female, Other, Unknown |
| BirthDate | DateOnly? | |
| DeathDate | DateOnly? | |

### Relationship
| Column | Type | Notes |
|--------|------|-------|
| Id | UUIDv7 | PK |
| SubjectId | UUIDv7 | FK → Person, indexed |
| RelativeId | UUIDv7 | FK → Person, indexed |
| Type | enum | Parent, Spouse |

---

## API Endpoints Summary

### Trees
- `GET /api/familytree/{id}` ✅ - Get tree with sample data
- `POST /api/trees` - Create tree
- `GET /api/trees` - List trees
- `PUT /api/trees/{id}` - Update tree
- `DELETE /api/trees/{id}` - Delete tree

### Persons
- `POST /api/trees/{treeId}/persons` - Add person
- `PUT /api/trees/{treeId}/persons/{id}` - Update person
- `DELETE /api/trees/{treeId}/persons/{id}` - Delete person

### Relationships
- `POST /api/trees/{treeId}/relationships` - Create relationship
- `DELETE /api/trees/{treeId}/relationships/{id}` - Remove relationship

---

## Performance Optimizations (1000 persons)

### Backend
- **Single query loading**: Load tree with persons + relationships in one query
- **Projection DTOs**: Return only needed fields for tree view
- **Indexed queries**: All FK columns indexed
- **UUIDv7 benefits**: Time-sortable IDs, better index locality

### Frontend
- **Viewport culling**: Only render visible nodes
- **Level-of-detail**: Simplified nodes when zoomed out
- **Incremental rendering**: Render in batches
